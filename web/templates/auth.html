{% extends "base.html" %}

{% block title %}
{% if page == 'login' %}Login - Socratic RAG Enhanced
{% elif page == 'register' %}Register - Socratic RAG Enhanced
{% elif page == 'profile' %}Profile - Socratic RAG Enhanced
{% else %}Authentication - Socratic RAG Enhanced
{% endif %}
{% endblock %}

{% block extra_head %}
<style>
.auth-container {
    min-height: calc(100vh - 200px);
}
.auth-card {
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}
.auth-header {
    background: linear-gradient(135deg, #0d6efd, #6610f2);
    border-radius: 0.75rem 0.75rem 0 0;
}
.form-floating input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
.password-strength {
    height: 4px;
    border-radius: 2px;
    margin-top: 5px;
    transition: all 0.3s ease;
}
.strength-weak { background: #dc3545; width: 25%; }
.strength-fair { background: #fd7e14; width: 50%; }
.strength-good { background: #ffc107; width: 75%; }
.strength-strong { background: #198754; width: 100%; }
</style>
{% endblock %}

{% block content %}
<div class="auth-container d-flex align-items-center justify-content-center py-5">
    <div class="row w-100 justify-content-center">
        <div class="col-md-6 col-lg-5">

            {% if page == 'login' or not page %}
            <!-- Login Form -->
            <div class="card auth-card">
                <div class="auth-header text-white text-center py-4">
                    <i class="bi bi-box-arrow-in-right display-4 mb-2"></i>
                    <h3 class="mb-0">Welcome Back</h3>
                    <p class="mb-0 opacity-75">Sign in to continue</p>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="loginForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <!-- Username Field -->
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="login_username" name="username"
                                   placeholder="Username" required autofocus>
                            <label>
                                <i class="bi bi-person-circle"></i> Username
                            </label>
                        </div>

                        <!-- Password Field -->
                        <div class="form-floating mb-3">
                            <input type="password" class="form-control" id="login_password" name="password"
                                   placeholder="Password" required>
                            <label>
                                <i class="bi bi-lock"></i> Password
                            </label>
                        </div>

                        <!-- Remember Me -->
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="remember" name="remember">
                            <label class="form-check-label" for="remember">
                                Remember me
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="bi bi-box-arrow-in-right"></i> Sign In
                        </button>

                        <!-- Links -->
                        <div class="text-center">
                            <a href="{{ url_for('register') }}" class="text-primary text-decoration-none">
                                <i class="bi bi-person-plus"></i> Create Account
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            {% elif page == 'register' %}
            <!-- Registration Form -->
            <div class="card auth-card">
                <div class="auth-header text-white text-center py-4">
                    <i class="bi bi-person-plus display-4 mb-2"></i>
                    <h3 class="mb-0">Create Account</h3>
                    <p class="mb-0 opacity-75">Join Socratic RAG Enhanced</p>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="registerForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                        <!-- Username Field (Required) -->
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="reg_username" name="username"
                                   placeholder="Username" required autofocus>
                            <label>
                                <i class="bi bi-person-circle"></i> Username *
                            </label>
                            <div class="form-text">
                                At least 3 characters (letters, numbers, hyphens, underscores)
                            </div>
                        </div>

                        <!-- Email Field (Optional) -->
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="reg_email" name="email"
                                   placeholder="Email">
                            <label>
                                <i class="bi bi-envelope"></i> Email (optional)
                            </label>
                        </div>

                        <!-- First Name Field (Optional) -->
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="reg_first_name" name="first_name"
                                   placeholder="First Name">
                            <label>
                                <i class="bi bi-person"></i> First Name (optional)
                            </label>
                        </div>

                        <!-- Last Name Field (Optional) -->
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="reg_last_name" name="last_name"
                                   placeholder="Last Name">
                            <label>
                                <i class="bi bi-person"></i> Last Name (optional)
                            </label>
                        </div>

                        <!-- Password Field (Required) -->
                        <div class="form-floating mb-3">
                            <input type="password" class="form-control" id="reg_password" name="password"
                                   placeholder="Password" required>
                            <label>
                                <i class="bi bi-lock"></i> Password *
                            </label>
                            <div class="password-strength" id="password-strength"></div>
                            <div class="form-text">
                                Minimum 6 characters
                            </div>
                        </div>

                        <!-- Confirm Password Field (Required) -->
                        <div class="form-floating mb-3">
                            <input type="password" class="form-control" id="reg_confirm_password"
                                   name="confirm_password" placeholder="Confirm Password" required>
                            <label>
                                <i class="bi bi-lock-fill"></i> Confirm Password *
                            </label>
                            <div id="password-match-message" class="form-text"></div>
                        </div>

                        <!-- Terms Acceptance (Required) -->
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="terms" name="terms" required>
                            <label class="form-check-label" for="terms">
                                I accept the <a href="#" class="text-primary">Terms of Service</a>
                                and <a href="#" class="text-primary">Privacy Policy</a> *
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="bi bi-person-plus"></i> Create Account
                        </button>

                        <!-- Links -->
                        <div class="text-center">
                            <a href="{{ url_for('login') }}" class="text-primary text-decoration-none">
                                <i class="bi bi-box-arrow-in-right"></i> Already have an account? Sign In
                            </a>
                        </div>

                        <div class="text-center mt-2">
                            <small class="text-muted">* Required fields</small>
                        </div>
                    </form>
                </div>
            </div>

            {% elif page == 'profile' %}
            <!-- User Profile -->
            <div class="card auth-card">
                <div class="auth-header text-white text-center py-4">
                    <i class="bi bi-person-circle display-4 mb-2"></i>
                    <h3 class="mb-0">{{ current_user.username if current_user else 'User' }}</h3>
                    <p class="mb-0 opacity-75">Profile Settings</p>
                </div>
                <div class="card-body p-4">
                    <!-- Profile Form -->
                    <form method="POST" id="profileForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="profile_username"
                                   value="{{ current_user.username if current_user else '' }}" readonly>
                            <label>Username</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="profile_email" name="email"
                                   value="{{ current_user.email if current_user else '' }}">
                            <label>Email Address</label>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="profile_first_name" name="first_name">
                                    <label>First Name</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="profile_last_name" name="last_name">
                                    <label>Last Name</label>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="bi bi-check-circle"></i> Update Profile
                        </button>

                        <button type="button" class="btn btn-outline-warning w-100" data-bs-toggle="modal"
                                data-bs-target="#changePasswordModal">
                            <i class="bi bi-key"></i> Change Password
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-key"></i> Change Password
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="current_password"
                               name="current_password" required>
                        <label>Current Password</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="new_password"
                               name="new_password" required>
                        <label>New Password</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="confirm_new_password"
                               name="confirm_new_password" required>
                        <label>Confirm New Password</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPasswordChange()">
                    <i class="bi bi-check-circle"></i> Update Password
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Authentication page JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeValidation();

    // Auto-focus first input
    const firstInput = document.querySelector('input:not([disabled]):not([readonly])');
    if (firstInput) {
        firstInput.focus();
    }
});

function initializeValidation() {
    // Password strength indicator
    const passwordInput = document.getElementById('reg_password');
    if (passwordInput) {
        passwordInput.addEventListener('input', checkPasswordStrength);
    }

    // Confirm password matching
    const confirmPasswordInput = document.getElementById('reg_confirm_password');
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        passwordInput?.addEventListener('input', checkPasswordMatch);
    }

    // Form validation on submit
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
        registerForm.addEventListener('submit', function(e) {
            if (!validateRegistrationForm(registerForm)) {
                e.preventDefault();
            }
        });
    }
}

function validateRegistrationForm(form) {
    let isValid = true;
    const formData = new FormData(form);

    // Clear previous errors
    form.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
    });

    // Validate username (required)
    const username = formData.get('username');
    if (!username || username.length < 3 || !/^[a-zA-Z0-9_-]+$/.test(username)) {
        form.querySelector('[name="username"]').classList.add('is-invalid');
        isValid = false;
    }

    // Validate email (optional, but if provided must be valid)
    const email = formData.get('email');
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        form.querySelector('[name="email"]').classList.add('is-invalid');
        isValid = false;
    }

    // Validate password (required, min 6 chars)
    const password = formData.get('password');
    if (!password || password.length < 6) {
        form.querySelector('[name="password"]').classList.add('is-invalid');
        isValid = false;
    }

    // Validate password match
    const confirmPassword = formData.get('confirm_password');
    if (password !== confirmPassword) {
        form.querySelector('[name="confirm_password"]').classList.add('is-invalid');
        isValid = false;
    }

    // Validate terms acceptance
    const terms = formData.get('terms');
    if (!terms) {
        form.querySelector('[name="terms"]').classList.add('is-invalid');
        isValid = false;
    }

    return isValid;
}

function checkPasswordStrength() {
    const password = document.getElementById('reg_password').value;
    const strengthBar = document.getElementById('password-strength');

    if (!strengthBar) return;

    if (password.length === 0) {
        strengthBar.className = 'password-strength';
        return;
    }

    let strength = 0;
    if (password.length >= 6) strength++;
    if (password.length >= 10) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;

    const classes = ['strength-weak', 'strength-fair', 'strength-good', 'strength-strong'];
    const strengthClass = classes[Math.min(Math.floor(strength / 1.5), 3)];

    strengthBar.className = 'password-strength ' + strengthClass;
}

function checkPasswordMatch() {
    const password = document.getElementById('reg_password')?.value;
    const confirmPassword = document.getElementById('reg_confirm_password')?.value;
    const messageDiv = document.getElementById('password-match-message');

    if (!messageDiv || !confirmPassword) return;

    if (password === confirmPassword) {
        messageDiv.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Passwords match</span>';
        document.getElementById('reg_confirm_password').classList.remove('is-invalid');
    } else {
        messageDiv.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Passwords do not match</span>';
        document.getElementById('reg_confirm_password').classList.add('is-invalid');
    }
}

function submitPasswordChange() {
    const form = document.getElementById('changePasswordForm');
    const formData = new FormData(form);

    // Validate passwords match
    if (formData.get('new_password') !== formData.get('confirm_new_password')) {
        alert('New passwords do not match');
        return;
    }

    // Submit password change
    fetch('/api/users/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            current_password: formData.get('current_password'),
            new_password: formData.get('new_password')
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Password changed successfully!');
            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
            form.reset();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error changing password: ' + error);
    });
}
</script>
{% endblock %}