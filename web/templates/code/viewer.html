{% extends "base.html" %}

{% block title %}{{ generation.generation_name }} - Code Viewer{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('projects') }}">Projects</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('project_detail', project_id=project.id) }}">{{ project.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('project_code', project_id=project.id) }}">Code Generation</a></li>
                    <li class="breadcrumb-item active">{{ generation.generation_name }}</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-code-slash text-primary"></i> {{ generation.generation_name }}</h2>
                    <p class="text-muted mb-0">
                        Architecture: <strong>{{ generation.architecture_pattern.replace('_', ' ').title() }}</strong> |
                        Status:
                        {% if generation.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                        {% elif generation.status == 'generating' %}
                            <span class="badge bg-warning">Generating</span>
                        {% elif generation.status == 'pending' %}
                            <span class="badge bg-secondary">Pending</span>
                        {% else %}
                            <span class="badge bg-danger">{{ generation.status.title() }}</span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    {% if generation.status == 'completed' and files %}
                    <a href="{{ url_for('download_generation', generation_id=generation.id) }}" class="btn btn-success me-2">
                        <i class="bi bi-download"></i> Download All
                    </a>
                    {% endif %}
                    <a href="{{ url_for('project_code', project_id=project.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Generations
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if files %}
    <!-- Main Content -->
    <div class="row">
        <!-- File Tree -->
        <div class="col-lg-3">
            <div class="card file-explorer">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-folder-open"></i> Project Files</h6>
                        <span class="badge bg-primary">{{ files|length }}</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="file-tree" id="fileTree">
                        <!-- File tree will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Viewer -->
        <div class="col-lg-9">
            <div class="card code-viewer">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0" id="currentFileName">
                            <i class="bi bi-file-code"></i> Select a file to view
                        </h6>
                        <small class="text-muted" id="currentFilePath"></small>
                    </div>
                    <div class="btn-group btn-group-sm" id="fileActions" style="display: none;">
                        <button class="btn btn-outline-primary" onclick="copyCode()" title="Copy Code">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="downloadFile()" title="Download File">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Welcome State -->
                    <div id="welcomeState" class="text-center py-5">
                        <i class="bi bi-folder-open display-1 text-muted mb-4"></i>
                        <h4>Project Structure Generated</h4>
                        <p class="text-muted mb-0">Select a file from the tree on the left to view its contents.</p>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-3 mb-0">Loading file content...</p>
                    </div>

                    <!-- Code Content -->
                    <div id="codeContent" style="display: none;">
                        <pre class="line-numbers"><code id="codeDisplay" class="language-python"></code></pre>
                    </div>

                    <!-- Markdown Content -->
                    <div id="markdownContent" style="display: none;">
                        <div id="markdownDisplay" class="p-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card text-center">
                <div class="card-body py-5">
                    {% if generation.status == 'generating' %}
                        <div class="spinner-border text-primary mb-4" role="status">
                            <span class="visually-hidden">Generating...</span>
                        </div>
                        <h4>Code Generation In Progress</h4>
                        <p class="text-muted mb-4">
                            Your code is being generated. This usually takes 30-60 seconds.
                        </p>
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: {{ (generation.completed_files / generation.total_files * 100) if generation.total_files > 0 else 25 }}%">
                            </div>
                        </div>
                        <p class="small text-muted">{{ generation.completed_files }}/{{ generation.total_files }} files generated</p>
                        <button class="btn btn-outline-primary" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    {% elif generation.status == 'pending' %}
                        <i class="bi bi-clock display-1 text-muted mb-4"></i>
                        <h4>Generation Pending</h4>
                        <p class="text-muted mb-4">
                            Your code generation is queued and will start shortly.
                        </p>
                        <button class="btn btn-outline-primary" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    {% elif generation.status == 'failed' %}
                        <i class="bi bi-exclamation-triangle display-1 text-danger mb-4"></i>
                        <h4>Generation Failed</h4>
                        <p class="text-muted mb-4">
                            There was an error generating your code. Please try creating a new generation.
                        </p>
                        <a href="{{ url_for('new_generation', project_id=project.id) }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Create New Generation
                        </a>
                    {% else %}
                        <i class="bi bi-file-code display-1 text-muted mb-4"></i>
                        <h4>No Files Generated</h4>
                        <p class="text-muted mb-4">
                            This generation doesn't have any files yet.
                        </p>
                        <a href="{{ url_for('project_code', project_id=project.id) }}" class="btn btn-primary">
                            <i class="bi bi-arrow-left"></i> Back to Generations
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Generation Details Modal -->
<div class="modal fade" id="generationDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generation Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>{{ generation.generation_name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Architecture:</strong></td>
                                <td>{{ generation.architecture_pattern.replace('_', ' ').title() }}</td>
                            </tr>
                            <tr>
                                <td><strong>Type:</strong></td>
                                <td>{{ generation.generation_type.replace('_', ' ').title() }}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td>
                                    {% if generation.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif generation.status == 'generating' %}
                                        <span class="badge bg-warning">Generating</span>
                                    {% elif generation.status == 'pending' %}
                                        <span class="badge bg-secondary">Pending</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ generation.status.title() }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Progress</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Files Generated:</strong></td>
                                <td>{{ generation.completed_files }}/{{ generation.total_files }}</td>
                            </tr>
                            <tr>
                                <td><strong>Created:</strong></td>
                                <td>{{ generation.created_at.strftime('%b %d, %Y at %I:%M %p') if generation.created_at else 'Recently' }}</td>
                            </tr>
                            {% if generation.completed_at %}
                            <tr>
                                <td><strong>Completed:</strong></td>
                                <td>{{ generation.completed_at.strftime('%b %d, %Y at %I:%M %p') }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>

                {% if generation.specifications %}
                <hr>
                <h6>Project Specifications</h6>
                <div class="bg-light p-3 rounded">
                    <pre class="mb-0" style="white-space: pre-wrap;">{{ generation.specifications }}</pre>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.file-explorer {
    height: calc(100vh - 200px);
    overflow: hidden;
}

.file-tree {
    height: calc(100vh - 280px);
    overflow-y: auto;
    padding: 10px;
}

.code-viewer {
    height: calc(100vh - 200px);
    overflow: hidden;
}

#codeContent {
    height: calc(100vh - 280px);
    overflow: auto;
}

.file-item {
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 4px;
    margin: 2px 0;
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}

.file-item:hover {
    background-color: #f8f9fa;
}

.file-item.active {
    background-color: #007bff;
    color: white;
}

.file-item.active:hover {
    background-color: #0056b3;
}

.folder-item {
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 4px;
    margin: 2px 0;
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    font-weight: 500;
}

.folder-item:hover {
    background-color: #e9ecef;
}

.folder-children {
    margin-left: 20px;
    border-left: 1px solid #dee2e6;
    padding-left: 10px;
}

.folder-children.collapsed {
    display: none;
}

.folder-toggle {
    margin-right: 5px;
    font-size: 0.8rem;
}

/* Prism.js customizations */
pre[class*="language-"] {
    margin: 0;
    padding: 20px;
    border: none;
    font-size: 0.875rem;
    line-height: 1.6;
    background-color: #2d2d2d !important;
}

code[class*="language-"] {
    background-color: transparent !important;
    padding: 0;
    font-family: 'Consolas', 'Monaco', 'Andale Mono', 'Ubuntu Mono', monospace;
}

.line-numbers .line-numbers-rows {
    border-right-color: #555;
}

.line-numbers-rows > span:before {
    color: #999;
}

/* Markdown styling */
#markdownContent {
    height: calc(100vh - 280px);
    overflow: auto;
    background-color: white;
}

#markdownDisplay {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    line-height: 1.6;
    color: #333;
}

#markdownDisplay h1,
#markdownDisplay h2,
#markdownDisplay h3,
#markdownDisplay h4,
#markdownDisplay h5,
#markdownDisplay h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}

#markdownDisplay h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
#markdownDisplay h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
#markdownDisplay h3 { font-size: 1.25em; }
#markdownDisplay h4 { font-size: 1em; }

#markdownDisplay code {
    background-color: rgba(27,31,35,0.05);
    border-radius: 3px;
    font-size: 85%;
    margin: 0;
    padding: 0.2em 0.4em;
    font-family: 'Consolas', 'Monaco', monospace;
}

#markdownDisplay pre {
    background-color: #f6f8fa;
    border-radius: 6px;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
}

#markdownDisplay pre code {
    background-color: transparent;
    padding: 0;
}

#markdownDisplay blockquote {
    border-left: 4px solid #dfe2e5;
    color: #6a737d;
    padding: 0 1em;
    margin: 0;
}

#markdownDisplay table {
    border-collapse: collapse;
    width: 100%;
    margin: 16px 0;
}

#markdownDisplay table th,
#markdownDisplay table td {
    border: 1px solid #dfe2e5;
    padding: 6px 13px;
}

#markdownDisplay table tr:nth-child(2n) {
    background-color: #f6f8fa;
}

#markdownDisplay img {
    max-width: 100%;
    height: auto;
}

#markdownDisplay a {
    color: #0366d6;
    text-decoration: none;
}

#markdownDisplay a:hover {
    text-decoration: underline;
}

/* Auto-refresh indicator */
.auto-refresh {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
}
</style>

<script>
let currentFileData = null;
const generationId = {{ generation.id }};

// File data from server
const filesData = {{ files|tojson }};

document.addEventListener('DOMContentLoaded', function() {
    buildFileTree();

    // Real-time progress polling for generating status
    {% if generation.status == 'generating' %}
    startProgressPolling();
    {% endif %}
});

// Poll for generation progress updates
let progressPollInterval = null;
let progressCheckCount = 0;

function startProgressPolling() {
    // Check progress every 2 seconds
    progressPollInterval = setInterval(checkGenerationProgress, 2000);
}

async function checkGenerationProgress() {
    try {
        const response = await fetch(`/api/generations/${generationId}/progress`);
        const data = await response.json();

        if (data.success) {
            // Update progress display
            updateProgressDisplay(data);

            // If generation is complete, refresh the page
            if (data.status === 'completed' || data.status === 'failed') {
                clearInterval(progressPollInterval);
                showProgressNotification(data);
                setTimeout(() => location.reload(), 2000);
            }
        }
        progressCheckCount++;
    } catch (error) {
        console.error('Error polling progress:', error);
    }
}

function updateProgressDisplay(data) {
    // Find the progress container in the empty state
    const progressContainer = document.querySelector('.progress');
    if (progressContainer) {
        const progressBar = progressContainer.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress + '%';
        }
    }

    // Update file count
    const fileCountEl = document.querySelector('p.small.text-muted');
    if (fileCountEl) {
        fileCountEl.textContent = `${data.completed_files}/${data.total_files} files generated`;
    }
}

function showProgressNotification(data) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${data.status === 'completed' ? 'success' : 'danger'} alert-dismissible fade show auto-refresh`;
    notification.innerHTML = `
        <i class="bi bi-${data.status === 'completed' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${data.message || (data.status === 'completed' ? 'Code generation completed!' : 'Generation failed')}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
}

function buildFileTree() {
    const fileTree = document.getElementById('fileTree');
    const treeStructure = organizeFiles(filesData);

    fileTree.innerHTML = renderTree(treeStructure);

    // Add click handlers
    document.querySelectorAll('.file-item').forEach(item => {
        item.addEventListener('click', () => loadFile(parseInt(item.dataset.fileId)));
    });

    document.querySelectorAll('.folder-item').forEach(item => {
        item.addEventListener('click', () => toggleFolder(item));
    });
}

function organizeFiles(files) {
    const tree = {};

    files.forEach(file => {
        const pathParts = file.file_path.split('/');
        let currentLevel = tree;

        // Build directory structure
        for (let i = 0; i < pathParts.length - 1; i++) {
            const part = pathParts[i];
            if (!currentLevel[part]) {
                currentLevel[part] = { type: 'folder', children: {} };
            }
            currentLevel = currentLevel[part].children;
        }

        // Add file
        const fileName = pathParts[pathParts.length - 1];
        currentLevel[fileName] = { type: 'file', data: file };
    });

    return tree;
}

function renderTree(tree, level = 0) {
    let html = '';

    // Sort: folders first, then files
    const entries = Object.entries(tree).sort(([a, aData], [b, bData]) => {
        if (aData.type !== bData.type) {
            return aData.type === 'folder' ? -1 : 1;
        }
        return a.localeCompare(b);
    });

    entries.forEach(([name, data]) => {
        if (data.type === 'folder') {
            html += `
                <div class="folder-item" data-folder="${name}">
                    <span class="folder-toggle">
                        <i class="bi bi-chevron-right"></i>
                    </span>
                    <i class="bi bi-folder me-2 text-warning"></i>
                    ${name}
                </div>
                <div class="folder-children" data-folder-children="${name}">
                    ${renderTree(data.children, level + 1)}
                </div>
            `;
        } else {
            const iconClass = getFileIcon(data.data.file_type);
            html += `
                <div class="file-item" data-file-id="${data.data.id}">
                    <i class="bi ${iconClass} me-2"></i>
                    ${name}
                </div>
            `;
        }
    });

    return html;
}

function getFileIcon(fileType) {
    const icons = {
        'python': 'bi-filetype-py text-success',
        'html': 'bi-filetype-html text-danger',
        'css': 'bi-filetype-css text-primary',
        'javascript': 'bi-filetype-js text-warning',
        'json': 'bi-filetype-json text-info',
        'yaml': 'bi-filetype-yml text-secondary',
        'markdown': 'bi-filetype-md text-dark',
        'sql': 'bi-filetype-sql text-info',
        'dockerfile': 'bi-file-code text-primary',
        'text': 'bi-file-text text-muted'
    };
    return icons[fileType] || 'bi-file-code text-muted';
}

function toggleFolder(folderItem) {
    const folderName = folderItem.dataset.folder;
    const children = document.querySelector(`[data-folder-children="${folderName}"]`);
    const toggle = folderItem.querySelector('.folder-toggle i');

    if (children.classList.contains('collapsed')) {
        children.classList.remove('collapsed');
        toggle.className = 'bi bi-chevron-down';
    } else {
        children.classList.add('collapsed');
        toggle.className = 'bi bi-chevron-right';
    }
}

async function loadFile(fileId) {
    try {
        // Show loading state
        document.getElementById('welcomeState').style.display = 'none';
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('codeContent').style.display = 'none';

        // Clear previous selection
        document.querySelectorAll('.file-item').forEach(item => item.classList.remove('active'));

        // Mark current selection
        document.querySelector(`[data-file-id="${fileId}"]`).classList.add('active');

        // Fetch file content
        const response = await fetch(`/generations/${generationId}/file/${fileId}`);
        const fileData = await response.json();

        if (response.ok) {
            currentFileData = fileData;
            displayFileContent(fileData);
        } else {
            throw new Error(fileData.error || 'Failed to load file');
        }

    } catch (error) {
        console.error('Error loading file:', error);
        alert('Error loading file: ' + error.message);

        // Reset to welcome state
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('welcomeState').style.display = 'block';
    }
}

function displayFileContent(fileData) {
    // Update header
    document.getElementById('currentFileName').innerHTML = `
        <i class="bi ${getFileIcon(fileData.file_type)}"></i> ${fileData.file_name}
    `;
    document.getElementById('currentFilePath').textContent = fileData.file_path;

    // Show file actions
    document.getElementById('fileActions').style.display = 'block';

    // Hide all content views
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('codeContent').style.display = 'none';
    document.getElementById('markdownContent').style.display = 'none';

    // Check if this is a Markdown file
    if (fileData.file_type === 'markdown' || fileData.file_name.endsWith('.md')) {
        // Render Markdown
        const markdownDisplay = document.getElementById('markdownDisplay');
        if (typeof marked !== 'undefined') {
            // Configure marked for GitHub-flavored markdown
            marked.setOptions({
                gfm: true,
                breaks: true,
                headerIds: true,
                mangle: false
            });
            markdownDisplay.innerHTML = marked.parse(fileData.content);
        } else {
            // Fallback if marked isn't loaded
            markdownDisplay.textContent = fileData.content;
        }
        document.getElementById('markdownContent').style.display = 'block';
    } else {
        // Display as code
        const codeDisplay = document.getElementById('codeDisplay');
        codeDisplay.textContent = fileData.content;

        // Map file types to Prism.js language classes
        const languageMap = {
            'python': 'python',
            'javascript': 'javascript',
            'html': 'markup',
            'css': 'css',
            'json': 'json',
            'yaml': 'yaml',
            'sql': 'sql',
            'dockerfile': 'docker',
            'text': 'plaintext'
        };

        const language = languageMap[fileData.file_type] || 'plaintext';
        codeDisplay.className = `language-${language}`;

        document.getElementById('codeContent').style.display = 'block';

        // Trigger Prism.js syntax highlighting
        if (typeof Prism !== 'undefined') {
            Prism.highlightElement(codeDisplay);
        }
    }
}

function copyCode() {
    if (currentFileData) {
        navigator.clipboard.writeText(currentFileData.content).then(() => {
            // Show success feedback
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i>';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-primary');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
            }, 1000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('Failed to copy code to clipboard');
        });
    }
}

function downloadFile() {
    if (currentFileData) {
        const blob = new Blob([currentFileData.content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentFileData.file_name;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
}

function showAutoRefreshNotification() {
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show auto-refresh';
    notification.innerHTML = `
        <i class="bi bi-arrow-clockwise"></i> Auto-refreshing in 3 seconds...
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
}

function showGenerationDetails() {
    const modal = new bootstrap.Modal(document.getElementById('generationDetailsModal'));
    modal.show();
}
</script>
{% endblock %}
