{% extends "base.html" %}

{% block title %}Projects - Socratic RAG Enhanced{% endblock %}

{% block extra_head %}
<style>
.project-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
}
.project-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}
.tech-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}
.json-editor {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col">
        <h1 class="display-6 mb-0">
            <i class="bi bi-folder text-primary"></i>
            {% if page == 'create' %}Create Project
            {% elif page == 'detail' and project %}{{ project.name }}
            {% else %}Projects
            {% endif %}
        </h1>
        <p class="text-muted">
            {% if page == 'create' %}Define your project specifications and technology stack
            {% elif page == 'detail' and project %}Project details and management
            {% else %}Manage your AI-powered development projects
            {% endif %}
        </p>
    </div>
    <div class="col-auto">
        {% if page != 'create' %}
        <div class="btn-group">
            <a href="{{ url_for('new_project') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> New Project
            </a>
            <button class="btn btn-outline-secondary" onclick="refreshProjects()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
        {% endif %}
    </div>
</div>

{% if page == 'create' %}
<!-- Full-Featured Project Creation Form -->
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card bg-dark border">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle"></i> Create New Project
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="projectForm">
                    {{ form.hidden_tag() }}

                    <!-- Basic Information Section -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-info-circle"></i> Basic Information
                    </h6>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-floating mb-3">
                                {{ form.name(class="form-control", placeholder="Project Name") }}
                                <label>
                                    <i class="bi bi-folder"></i> Project Name
                                </label>
                                {% if form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.name.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                {{ form.project_type(class="form-select") }}
                                <label>Project Type</label>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="form-floating mb-4">
                        {{ form.description(class="form-control", placeholder="Project Description", rows="3") }}
                        <label>
                            <i class="bi bi-file-text"></i> Description
                        </label>
                        {% if form.description.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.description.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Technology Stack Section -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-stack"></i> Technology Stack
                    </h6>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Primary Language</label>
                            <select class="form-select" id="primary_language" onchange="updateTechStack()">
                                <option value="">Select Language</option>
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="typescript">TypeScript</option>
                                <option value="java">Java</option>
                                <option value="csharp">C#</option>
                                <option value="go">Go</option>
                                <option value="rust">Rust</option>
                                <option value="php">PHP</option>
                                <option value="ruby">Ruby</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Framework</label>
                            <select class="form-select" id="framework" onchange="updateTechStackJSON()">
                                <option value="">Select Framework</option>
                            </select>
                        </div>
                    </div>

                    <!-- Quick Technology Buttons -->
                    <div class="mb-3">
                        <label class="form-label small">Quick Add:</label>
                        <div class="btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addTech('database', 'postgresql')">PostgreSQL</button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addTech('database', 'mongodb')">MongoDB</button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addTech('cache', 'redis')">Redis</button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addTech('deployment', 'docker')">Docker</button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addTech('cloud', 'aws')">AWS</button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="addTech('cloud', 'azure')">Azure</button>
                        </div>
                    </div>

                    <!-- Technology Stack JSON Editor -->
                    <div class="form-floating mb-4">
                        {{ form.tech_stack(class="form-control json-editor", placeholder="Technology Stack JSON", rows="6") }}
                        <label>Technology Stack (JSON)</label>
                        <div class="form-text">
                            Define your technology stack in JSON format. Example: {"language": "python", "framework": "flask", "database": "postgresql"}
                        </div>
                        {% if form.tech_stack.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.tech_stack.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Requirements Section -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-list-check"></i> Requirements
                    </h6>

                    <div class="form-floating mb-4">
                        {{ form.requirements(class="form-control", placeholder="Project Requirements", rows="4") }}
                        <label>
                            <i class="bi bi-list-ul"></i> Requirements
                        </label>
                        <div class="form-text">
                            List your project requirements (one per line or comma-separated)
                        </div>
                        {% if form.requirements.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.requirements.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Planning & Priority Section -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-calendar-check"></i> Planning & Priority
                    </h6>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.estimated_hours(class="form-control", placeholder="Estimated Hours") }}
                                <label>Estimated Hours</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.priority(class="form-select") }}
                                <label>Priority</label>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('projects') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cancel
                        </a>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="previewProject()">
                                <i class="bi bi-eye"></i> Preview
                            </button>
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% elif page == 'detail' and project %}
<!-- Project Detail View -->
<div class="row">
    <div class="col-lg-8">
        <div class="card bg-dark border mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Project Information
                </h5>
                <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('sessions') }}?project_id={{ project.id }}" class="btn btn-outline-success">
                        <i class="bi bi-chat-dots"></i> Start Session
                    </a>
                    <a href="{{ url_for('code') }}?project_id={{ project.id }}" class="btn btn-outline-info">
                        <i class="bi bi-code-slash"></i> Generate Code
                    </a>
                </div>
            </div>
            <div class="card-body">
                <h4>{{ project.name }}</h4>
                <p class="text-muted mb-3">{{ project.description or 'No description provided' }}</p>

                {% if project.technology_stack %}
                <h6>Technology Stack</h6>
                <div class="mb-3">
                    {% for key, value in project.technology_stack.items() %}
                    <span class="badge bg-secondary me-1">{{ key }}: {{ value }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if project.requirements %}
                <h6>Requirements</h6>
                <ul class="mb-3">
                    {% for req in project.requirements %}
                    <li>{{ req }}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                <div class="row mt-3">
                    <div class="col-md-4">
                        <small class="text-muted">Priority:</small>
                        <div>
                            {% if project.priority == 'high' %}
                            <span class="badge bg-danger">High</span>
                            {% elif project.priority == 'medium' %}
                            <span class="badge bg-warning">Medium</span>
                            {% else %}
                            <span class="badge bg-info">Low</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">Estimated Hours:</small>
                        <div>{{ project.estimated_hours or 'Not specified' }}</div>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">Status:</small>
                        <div>{{ project.status.value if project.status else 'Unknown' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card bg-dark border mb-4">
            <div class="card-header">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('sessions') }}?project_id={{ project.id }}" class="btn btn-success">
                        <i class="bi bi-chat-dots"></i> Socratic Session
                    </a>
                    <a href="{{ url_for('code') }}?project_id={{ project.id }}" class="btn btn-info">
                        <i class="bi bi-code-slash"></i> Generate Code
                    </a>
                    <button class="btn btn-outline-secondary" disabled>
                        <i class="bi bi-gear"></i> Settings
                    </button>
                    {% if project.owner_id == current_user.id %}
                    <hr>
                    <button onclick="confirmDelete('{{ project.id }}', '{{ project.name }}')"
                            class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete Project
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Project List View -->
<div class="row">
    {% if projects %}
    <div class="col-12">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for project in projects %}
            <div class="col">
                <div class="card project-card bg-dark h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">
                            <i class="bi bi-folder-fill text-primary"></i>
                            {{ project.name }}
                        </h5>

                        <p class="card-text text-muted flex-grow-1">
                            {{ project.description[:100] + '...' if project.description and project.description|length > 100 else project.description or 'No description' }}
                        </p>

                        {% if project.technology_stack %}
                        <div class="mb-3">
                            <small class="text-muted">Tech Stack:</small>
                            <div class="mt-1">
                                {% for key, value in project.technology_stack.items() %}
                                <span class="badge bg-secondary tech-badge">{{ value }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    Updated {{ project.updated_at.strftime('%m/%d/%Y') if project.updated_at else 'Never' }}
                                </small>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('project_detail', project_id=project.id) }}"
                                       class="btn btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('sessions') }}?project_id={{ project.id }}"
                                       class="btn btn-outline-success">
                                        <i class="bi bi-chat-dots"></i>
                                    </a>
                                    <a href="{{ url_for('code') }}?project_id={{ project.id }}"
                                       class="btn btn-outline-info">
                                        <i class="bi bi-code-slash"></i>
                                    </a>
                                    {% if project.owner_id == current_user.id %}
                                    <button onclick="confirmDelete('{{ project.id }}', '{{ project.name }}')"
                                            class="btn btn-outline-danger"
                                            title="Delete Project">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="col-12">
        <div class="text-center py-5">
            <i class="bi bi-folder-plus display-1 text-muted mb-4"></i>
            <h3>No Projects Yet</h3>
            <p class="text-muted mb-4 lead">Create your first project to start building with AI-powered assistance.</p>
            <a href="{{ url_for('new_project') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle"></i> Create Your First Project
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
// Technology stack framework mappings
const frameworkMapping = {
    'python': ['flask', 'django', 'fastapi', 'pyramid', 'tornado'],
    'javascript': ['react', 'vue', 'angular', 'express', 'nextjs'],
    'typescript': ['react', 'vue', 'angular', 'nestjs', 'nextjs'],
    'java': ['spring', 'spring-boot', 'struts', 'jsf'],
    'csharp': ['asp.net', 'blazor', '.net-core', 'mvc'],
    'go': ['gin', 'echo', 'fiber', 'beego'],
    'rust': ['actix', 'rocket', 'warp', 'axum'],
    'php': ['laravel', 'symfony', 'codeigniter'],
    'ruby': ['rails', 'sinatra']
};

document.addEventListener('DOMContentLoaded', function() {
    initializeTechStackEditor();
    setupFormValidation();
});

function updateTechStack() {
    const language = document.getElementById('primary_language').value;
    const frameworkSelect = document.getElementById('framework');

    frameworkSelect.innerHTML = '<option value="">Select Framework</option>';

    if (language && frameworkMapping[language]) {
        frameworkMapping[language].forEach(framework => {
            const option = document.createElement('option');
            option.value = framework;
            option.textContent = framework.charAt(0).toUpperCase() + framework.slice(1);
            frameworkSelect.appendChild(option);
        });
    }

    updateTechStackJSON();
}

function updateTechStackJSON() {
    const language = document.getElementById('primary_language').value;
    const framework = document.getElementById('framework').value;
    const techStackTextarea = document.querySelector('[name="tech_stack"]');

    if (techStackTextarea) {
        try {
            let techStack = {};
            if (techStackTextarea.value) {
                try {
                    techStack = JSON.parse(techStackTextarea.value);
                } catch(e) {
                    techStack = {};
                }
            }

            if (language) techStack.language = language;
            if (framework) techStack.framework = framework;

            techStackTextarea.value = JSON.stringify(techStack, null, 2);
        } catch (e) {
            console.error('Error updating tech stack JSON:', e);
        }
    }
}

function addTech(category, technology) {
    const techStackTextarea = document.querySelector('[name="tech_stack"]');

    if (techStackTextarea) {
        try {
            let techStack = {};
            if (techStackTextarea.value) {
                try {
                    techStack = JSON.parse(techStackTextarea.value);
                } catch(e) {
                    techStack = {};
                }
            }

            techStack[category] = technology;
            techStackTextarea.value = JSON.stringify(techStack, null, 2);
        } catch (e) {
            console.error('Error adding technology:', e);
        }
    }
}

function initializeTechStackEditor() {
    const techStackTextarea = document.querySelector('[name="tech_stack"]');
    if (techStackTextarea && !techStackTextarea.value) {
        techStackTextarea.value = JSON.stringify({
            "language": "",
            "framework": "",
            "database": "",
            "deployment": ""
        }, null, 2);
    }
}

function setupFormValidation() {
    const form = document.getElementById('projectForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const techStackField = document.querySelector('[name="tech_stack"]');
            if (techStackField && techStackField.value) {
                try {
                    JSON.parse(techStackField.value);
                } catch (error) {
                    e.preventDefault();
                    alert('Invalid JSON in Technology Stack field');
                    techStackField.focus();
                    return false;
                }
            }
        });
    }
}

function previewProject() {
    const formData = new FormData(document.getElementById('projectForm'));
    alert('Preview functionality: Would show a formatted preview of the project specifications');
}

function refreshProjects() {
    window.location.reload();
}

function confirmDelete(projectId, projectName) {
    if (confirm(`Are you sure you want to delete "${projectName}"?\n\nThis will permanently delete:\n- The project\n- All modules\n- All collaborators\n- All generated code\n- All related data\n\nThis action cannot be undone.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/projects/${projectId}/delete`;

        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.content;
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}