{% extends "base.html" %}

{% block title %}Socratic Sessions - Socratic RAG Enhanced{% endblock %}

{% block extra_head %}
<style>
/* Page Header */
.sessions-header {
    background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
    color: white;
    padding: 2.5rem 2rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.sessions-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 400px;
    height: 400px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
}

.sessions-header-content {
    position: relative;
    z-index: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 2rem;
}

.sessions-header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.sessions-header p {
    opacity: 0.9;
    margin: 0;
}

/* Sessions Panel */
.sessions-panel {
    background: linear-gradient(135deg, #313335 0%, #3c3f41 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.sessions-header-bar {
    padding: 1.25rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.sessions-header-bar h5 {
    color: #a9b7c6;
    font-weight: 600;
    margin-bottom: 0;
}

.sessions-list {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.session-card {
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
    cursor: pointer;
    background: transparent;
}

.session-card:hover {
    background: rgba(255, 255, 255, 0.02);
    transform: translateX(4px);
}

.session-card.active {
    background: rgba(13, 110, 253, 0.15);
    border-left: 4px solid #0d6efd;
    border-bottom-color: rgba(13, 110, 253, 0.2);
}

.session-title {
    color: #a9b7c6;
    font-weight: 600;
    margin-bottom: 0.4rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.session-description {
    color: #6c7a89;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.session-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: #6c7a89;
}

/* Chat Container */
.chat-container {
    height: 500px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    background: linear-gradient(135deg, rgba(49, 51, 53, 0.5) 0%, rgba(60, 63, 65, 0.5) 100%);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.message {
    display: flex;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-user {
    justify-content: flex-end;
}

.message-user .message-content {
    background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 1rem 1rem 0.25rem 1rem;
    max-width: 75%;
    word-break: break-word;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
}

.message-assistant {
    justify-content: flex-start;
}

.message-assistant .message-content {
    background: rgba(108, 117, 125, 0.2);
    border: 1px solid rgba(13, 110, 253, 0.2);
    border-left: 4px solid #0d6efd;
    color: #a9b7c6;
    padding: 0.75rem 1rem;
    border-radius: 1rem 1rem 1rem 0.25rem;
    max-width: 75%;
    word-break: break-word;
}

.message-timestamp {
    font-size: 0.7rem;
    color: #6c7a89;
    margin-bottom: 0.3rem;
    text-align: inherit;
}

.typing-indicator {
    display: none;
    justify-content: flex-start;
}

.typing-indicator.active {
    display: flex;
}

.typing-dots {
    display: inline-flex;
    gap: 0.3rem;
}

.typing-dots span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #6fb3f5;
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% { transform: scale(0.8); opacity: 0.5; }
    30% { transform: scale(1.2); opacity: 1; }
}

.role-badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    background: rgba(13, 110, 253, 0.2);
    border: 1px solid rgba(13, 110, 253, 0.3);
    color: #6fb3f5;
    border-radius: 0.25rem;
}

/* Chat Header & Actions */
.chat-header {
    background: linear-gradient(135deg, #313335 0%, #3c3f41 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.chat-title {
    color: #a9b7c6;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.chat-subtitle {
    color: #6c7a89;
    font-size: 0.85rem;
}

.session-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

/* Quick Responses */
.quick-responses-section {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.quick-response-label {
    color: #6c7a89;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.75rem;
    display: block;
}

.quick-response-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.quick-response {
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
    background: rgba(13, 110, 253, 0.1);
    border: 1px solid rgba(13, 110, 253, 0.3);
    color: #6fb3f5;
    border-radius: 0.35rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
}

.quick-response:hover {
    background: rgba(13, 110, 253, 0.2);
    border-color: rgba(13, 110, 253, 0.5);
    color: #0d6efd;
}

/* Insights Panel */
.insights-panel {
    background: linear-gradient(135deg, #313335 0%, #3c3f41 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    overflow: hidden;
    margin-top: 2rem;
}

.insights-header {
    background: rgba(13, 110, 253, 0.1);
    border-bottom: 1px solid rgba(13, 110, 253, 0.2);
    padding: 1rem 1.25rem;
    cursor: pointer;
    user-select: none;
}

.insights-title {
    color: #a9b7c6;
    font-weight: 600;
    margin-bottom: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.insights-body {
    padding: 1.5rem;
    max-height: 400px;
    overflow-y: auto;
}

.insight-section {
    margin-bottom: 2rem;
}

.insight-section:last-child {
    margin-bottom: 0;
}

.insight-section-title {
    color: #a9b7c6;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.insight-item {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 0.5rem;
    border-left: 3px solid #0d6efd;
}

.insight-item-icon {
    flex-shrink: 0;
    margin-top: 0.1rem;
}

.insight-item-content {
    flex-grow: 1;
}

.insight-item-title {
    color: #a9b7c6;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.2rem;
}

.insight-item-text {
    color: #6c7a89;
    font-size: 0.85rem;
    margin: 0;
}

.insight-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: rgba(13, 110, 253, 0.2);
    border: 1px solid rgba(13, 110, 253, 0.3);
    color: #6fb3f5;
    border-radius: 0.25rem;
    font-size: 0.7rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

@media (max-width: 992px) {
    .sessions-header-content {
        flex-direction: column;
        align-items: flex-start;
    }

    .session-card {
        min-width: 100%;
    }
}

@media (max-width: 768px) {
    .sessions-header h1 {
        font-size: 1.5rem;
    }

    .message-user .message-content,
    .message-assistant .message-content {
        max-width: 90%;
    }

    .session-actions {
        justify-content: center;
    }

    .insights-body {
        max-height: 300px;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="sessions-header">
    <div class="sessions-header-content">
        <div>
            <h1>
                <i class="bi bi-chat-quote"></i> Socratic Sessions
            </h1>
            <p>AI-powered questioning sessions for collaborative project development</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="startNewSession()">
                <i class="bi bi-plus-circle"></i> New Session
            </button>
            <button class="btn btn-outline-light" onclick="refreshSessions()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sessions List -->
    <div class="col-lg-4 mb-4">
        <div class="sessions-panel">
            <div class="sessions-header-bar">
                <h5>
                    <i class="bi bi-list-task"></i> Sessions
                    <small style="color: #6c7a89; font-weight: 400;">(<span id="session-count">3</span>)</small>
                </h5>
            </div>
            <div class="sessions-list" id="sessions-list">
                <!-- Sample sessions -->
                <div class="session-card active" onclick="loadSession('session-1')">
                    <div class="session-title">
                        <span><i class="bi bi-chat-dots"></i> E-commerce Platform</span>
                        <span class="role-badge">Developer</span>
                    </div>
                    <div class="session-description">
                        Discussing architecture and database design for online store...
                    </div>
                    <div class="session-meta">
                        <span><i class="bi bi-clock"></i> 15 min ago</span>
                        <span style="background: rgba(13, 110, 253, 0.2); padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem;">12 messages</span>
                    </div>
                </div>

                <div class="session-card" onclick="loadSession('session-2')">
                    <div class="session-title">
                        <span><i class="bi bi-chat-dots"></i> Mobile App MVP</span>
                        <span class="role-badge" style="background: rgba(255, 193, 7, 0.2); border-color: rgba(255, 193, 7, 0.3); color: #ffc107;">Manager</span>
                    </div>
                    <div class="session-description">
                        Planning project scope and timeline requirements...
                    </div>
                    <div class="session-meta">
                        <span><i class="bi bi-clock"></i> 1 hour ago</span>
                        <span style="background: rgba(13, 110, 253, 0.2); padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem;">8 messages</span>
                    </div>
                </div>

                <div class="session-card" onclick="loadSession('session-3')">
                    <div class="session-title">
                        <span><i class="bi bi-chat-dots"></i> API Integration</span>
                        <span class="role-badge" style="background: rgba(81, 207, 102, 0.2); border-color: rgba(81, 207, 102, 0.3); color: #51cf66;">Designer</span>
                    </div>
                    <div class="session-description">
                        Exploring user experience and interface patterns...
                    </div>
                    <div class="session-meta">
                        <span><i class="bi bi-clock"></i> 2 hours ago</span>
                        <span style="background: rgba(13, 110, 253, 0.2); padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem;">5 messages</span>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div style="text-align: center; padding: 2rem 1rem; color: #6c7a89; d-none;" id="sessions-empty">
                <i class="bi bi-chat-dots" style="font-size: 2rem; display: block; margin-bottom: 1rem;"></i>
                <div style="font-weight: 600; margin-bottom: 0.5rem;">No Active Sessions</div>
                <p style="margin-bottom: 1rem; font-size: 0.85rem;">Start a new Socratic session to begin.</p>
                <button class="btn btn-primary btn-sm" onclick="startNewSession()">
                    <i class="bi bi-plus-circle"></i> Start
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-lg-8">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="row align-items-start">
                <div class="col">
                    <h5 class="chat-title mb-0" id="session-title">
                        <i class="bi bi-chat-dots"></i> E-commerce Platform Discussion
                    </h5>
                    <div style="margin-top: 0.5rem;">
                        <span class="role-badge me-2">Developer Role</span>
                        <small class="chat-subtitle">Session started 45 minutes ago</small>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="session-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="exportSession()" title="Export Session">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="generateFromSession()" title="Generate Code">
                            <i class="bi bi-code-slash"></i> Generate
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="pauseSession()" title="Pause Session">
                            <i class="bi bi-pause"></i> Pause
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="endSession()" title="End Session">
                            <i class="bi bi-stop-fill"></i> End
                        </button>
                    </div>
                </div>
            </div>
        </div>

            <!-- Chat Messages -->
            <div class="card-body d-flex flex-column">
                <div class="chat-container p-3 mb-3" id="chat-messages">
                    <!-- Sample conversation -->
                    <div class="message message-assistant">
                        <div class="mb-1">
                            <small class="text-muted">
                                <i class="bi bi-robot"></i> AI Assistant • 15:30
                            </small>
                        </div>
                        <div class="message-content">
                            Hello! I'm here to help you develop your e-commerce platform through strategic questioning. As a developer, let's start by exploring your technical requirements.
                            <br><br>
                            <strong>What type of products will your e-commerce platform sell, and do you anticipate any special requirements like digital downloads, subscriptions, or complex inventory tracking?</strong>
                        </div>
                    </div>

                    <div class="message message-user">
                        <div class="mb-1 text-end">
                            <small class="text-muted">
                                You • 15:32
                            </small>
                        </div>
                        <div class="message-content">
                            We're planning to sell both physical and digital products. Physical items like electronics and books, plus digital courses and software licenses. We'll need inventory tracking for physical items and license management for digital products.
                        </div>
                    </div>

                    <div class="message message-assistant">
                        <div class="mb-1">
                            <small class="text-muted">
                                <i class="bi bi-robot"></i> AI Assistant • 15:33
                            </small>
                        </div>
                        <div class="message-content">
                            Excellent! A hybrid physical-digital product model adds complexity but also great potential. This tells me we'll need sophisticated inventory and license management systems.
                            <br><br>
                            <strong>Given the complexity of managing both physical inventory and digital licenses, what's your expected scale? Are we talking hundreds of products or thousands? And what's your projected user base in the first year?</strong>
                        </div>
                    </div>

                    <div class="message message-user">
                        <div class="mb-1 text-end">
                            <small class="text-muted">
                                You • 15:35
                            </small>
                        </div>
                        <div class="message-content">
                            We're starting with about 500 physical products and 50 digital products. Expecting around 1,000 users in the first 3 months, growing to 10,000 in the first year.
                        </div>
                    </div>

                    <!-- Typing Indicator -->
                    <div class="message message-assistant typing-indicator" id="typing-indicator">
                        <div class="mb-1">
                            <small class="text-muted">
                                <i class="bi bi-robot"></i> AI Assistant is typing...
                            </small>
                        </div>
                        <div class="message-content">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Response Suggestions -->
                <div class="quick-responses-section" id="quick-responses">
                    <span class="quick-response-label">
                        <i class="bi bi-lightbulb"></i> Quick responses:
                    </span>
                    <div class="quick-response-buttons">
                        <button class="quick-response"
                                onclick="useQuickResponse('We need mobile-responsive design')">
                            Mobile-responsive design
                        </button>
                        <button class="quick-response"
                                onclick="useQuickResponse('Payment integration is crucial')">
                            Payment integration
                        </button>
                        <button class="quick-response"
                                onclick="useQuickResponse('Need admin dashboard')">
                            Admin dashboard
                        </button>
                        <button class="quick-response"
                                onclick="useQuickResponse('Security is a top priority')">
                            Security priority
                        </button>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="mt-auto">
                    <form id="message-form" onsubmit="sendMessage(event)">
                        <div class="input-group">
                            <textarea class="form-control"
                                    id="message-input"
                                    placeholder="Type your response..."
                                    rows="2"
                                    onkeydown="handleEnterKey(event)"
                                    maxlength="2000"></textarea>
                            <button class="btn btn-primary" type="submit" id="send-button">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                        <div class="form-text text-end mt-1">
                            <span id="char-count">0</span>/2000 characters
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Session Insights Panel (Collapsible) -->
<div class="insights-panel">
    <div class="insights-header" data-bs-toggle="collapse" data-bs-target="#insights-panel">
        <h5 class="insights-title">
            <span>
                <i class="bi bi-lightbulb"></i> Session Insights & Analysis
            </span>
            <i class="bi bi-chevron-down"></i>
        </h5>
    </div>
    <div class="collapse show" id="insights-panel">
        <div class="insights-body">
                    <div class="row">
                        <!-- Key Insights -->
                        <div class="col-lg-4">
                            <div class="insight-section">
                                <div class="insight-section-title">
                                    <i class="bi bi-lightbulb"></i> Key Insights
                                </div>
                                <div class="insight-item">
                                    <div class="insight-item-icon">
                                        <i class="bi bi-check-circle" style="color: #51cf66;"></i>
                                    </div>
                                    <div class="insight-item-content">
                                        <div class="insight-item-title">Hybrid Product Model</div>
                                        <p class="insight-item-text">
                                            Mixed physical and digital products require specialized inventory management
                                        </p>
                                    </div>
                                </div>

                                <div class="insight-item">
                                    <div class="insight-item-icon">
                                        <i class="bi bi-exclamation-triangle" style="color: #ffc107;"></i>
                                    </div>
                                    <div class="insight-item-content">
                                        <div class="insight-item-title">Scalability Concerns</div>
                                        <p class="insight-item-text">
                                            Growth from 1K to 10K users requires careful architecture planning
                                        </p>
                                    </div>
                                </div>

                                <div class="insight-item">
                                    <div class="insight-item-icon">
                                        <i class="bi bi-info-circle" style="color: #6fb3f5;"></i>
                                    </div>
                                    <div class="insight-item-content">
                                        <div class="insight-item-title">Technical Requirements</div>
                                        <p class="insight-item-text">
                                            Need for license management and inventory tracking systems
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technology Recommendations -->
                        <div class="col-lg-4">
                            <div class="insight-section">
                                <div class="insight-section-title">
                                    <i class="bi bi-tools"></i> Tech Stack
                                </div>
                                <div>
                                    <span class="insight-badge">Backend</span>
                                    <span style="color: #a9b7c6; font-size: 0.9rem;">Python + Django/FastAPI</span><br><br>
                                    <span class="insight-badge">Database</span>
                                    <span style="color: #a9b7c6; font-size: 0.9rem;">PostgreSQL + Redis</span><br><br>
                                    <span class="insight-badge">Frontend</span>
                                    <span style="color: #a9b7c6; font-size: 0.9rem;">React + TypeScript</span><br><br>
                                    <span class="insight-badge">Payments</span>
                                    <span style="color: #a9b7c6; font-size: 0.9rem;">Stripe + PayPal</span><br><br>
                                    <span class="insight-badge">Hosting</span>
                                    <span style="color: #a9b7c6; font-size: 0.9rem;">AWS/Docker</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Items -->
                        <div class="col-lg-4">
                            <div class="insight-section">
                                <div class="insight-section-title">
                                    <i class="bi bi-checklist"></i> Next Steps
                                </div>
                                <div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="action1">
                                        <label class="form-check-label small" for="action1" style="color: #a9b7c6;">
                                            Define user authentication
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="action2">
                                        <label class="form-check-label small" for="action2" style="color: #a9b7c6;">
                                            Plan payment integration
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="action3">
                                        <label class="form-check-label small" for="action3" style="color: #a9b7c6;">
                                            Design database schema
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="action4">
                                        <label class="form-check-label small" for="action4" style="color: #a9b7c6;">
                                            Research license solutions
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="action5">
                                        <label class="form-check-label small" for="action5" style="color: #a9b7c6;">
                                            Plan responsive UI design
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- New Session Modal -->
<div class="modal fade" id="newSessionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Start New Socratic Session
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newSessionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="session_name" placeholder="Session Name" required>
                                <label>Session Name</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="session_role" required>
                                    <option value="">Select Role Perspective</option>
                                    <option value="developer">Software Developer</option>
                                    <option value="manager">Project Manager</option>
                                    <option value="designer">UI/UX Designer</option>
                                    <option value="tester">QA Tester</option>
                                    <option value="business_analyst">Business Analyst</option>
                                    <option value="devops">DevOps Engineer</option>
                                    <option value="architect">Solution Architect</option>
                                </select>
                                <label>Role Perspective</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mb-3">
                        <select class="form-select" id="existing_project">
                            <option value="">Create New Project</option>
                            <option value="project1">E-commerce Platform</option>
                            <option value="project2">Mobile App MVP</option>
                            <option value="project3">API Integration</option>
                        </select>
                        <label>Link to Existing Project (Optional)</label>
                    </div>

                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="initial_idea" placeholder="Initial Idea" rows="3"></textarea>
                        <label>Initial Project Idea or Question</label>
                        <div class="form-text">
                            Describe your project idea or ask a specific question to get started
                        </div>
                    </div>

                    <!-- Role-specific guidance -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Role Guidance:</strong>
                        <div id="role-guidance">
                            Select a role perspective to see specialized questioning focus.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createNewSession()">
                    <i class="bi bi-chat-dots"></i> Start Session
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Sessions page JavaScript
let currentSessionId = 'session-1';
let isTyping = false;

// Role guidance text
const roleGuidance = {
    'developer': 'Focus on technical architecture, implementation details, code quality, and development best practices.',
    'manager': 'Emphasize project planning, resource allocation, timeline management, and stakeholder coordination.',
    'designer': 'Explore user experience, interface design, usability, accessibility, and design systems.',
    'tester': 'Investigate quality assurance, testing strategies, edge cases, and validation scenarios.',
    'business_analyst': 'Examine business requirements, processes, stakeholder needs, and compliance considerations.',
    'devops': 'Consider infrastructure, deployment, monitoring, security, and operational requirements.',
    'architect': 'Address system design, scalability, integration patterns, and technical decision-making.'
};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize character counter
    updateCharCount();

    // Set up message input listeners
    const messageInput = document.getElementById('message-input');
    messageInput.addEventListener('input', updateCharCount);

    // Set up role guidance
    const roleSelect = document.getElementById('session_role');
    if (roleSelect) {
        roleSelect.addEventListener('change', updateRoleGuidance);
    }

    // Auto-scroll chat to bottom
    scrollChatToBottom();
});

function updateCharCount() {
    const input = document.getElementById('message-input');
    const counter = document.getElementById('char-count');
    if (input && counter) {
        counter.textContent = input.value.length;
    }
}

function updateRoleGuidance() {
    const roleSelect = document.getElementById('session_role');
    const guidanceDiv = document.getElementById('role-guidance');

    if (roleSelect && guidanceDiv) {
        const selectedRole = roleSelect.value;
        guidanceDiv.textContent = roleGuidance[selectedRole] || 'Select a role perspective to see specialized questioning focus.';
    }
}

function handleEnterKey(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage(event) {
    if (event) event.preventDefault();

    const input = document.getElementById('message-input');
    const message = input.value.trim();

    if (!message || isTyping) return;

    // Add user message to chat
    addMessageToChat(message, 'user');

    // Clear input
    input.value = '';
    updateCharCount();

    // Show typing indicator
    showTypingIndicator();

    // Simulate AI response (in real implementation, this would be an API call)
    setTimeout(() => {
        hideTypingIndicator();
        const aiResponse = generateAIResponse(message);
        addMessageToChat(aiResponse, 'assistant');
        updateQuickResponses();
    }, 2000 + Math.random() * 2000);
}

function addMessageToChat(message, sender) {
    const chatContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    messageDiv.className = `message message-${sender}`;
    messageDiv.innerHTML = `
        <div class="mb-1 ${sender === 'user' ? 'text-end' : ''}">
            <small class="text-muted">
                ${sender === 'assistant' ? '<i class="bi bi-robot"></i> AI Assistant' : 'You'} • ${timestamp}
            </small>
        </div>
        <div class="message-content">
            ${message.replace(/\n/g, '<br>')}
        </div>
    `;

    // Insert before typing indicator
    const typingIndicator = document.getElementById('typing-indicator');
    chatContainer.insertBefore(messageDiv, typingIndicator);

    scrollChatToBottom();
}

function generateAIResponse(userMessage) {
    // Sample AI responses - in real implementation, this would be from the Claude API
    const responses = [
        "That's a great point about scalability. Let me explore this further: <strong>How do you plan to handle peak traffic loads, especially during sales events or product launches?</strong>",
        "I understand your concern about security. <strong>What specific user data will you be collecting, and what compliance requirements (like GDPR, CCPA) do you need to consider?</strong>",
        "Interesting approach to the user interface. <strong>Have you considered the different user types (buyers vs. sellers vs. admins) and their varying needs? What would be the primary workflow for each?</strong>",
        "Your technology choices make sense for this scale. <strong>What's your team's current expertise level with these technologies, and do you have plans for knowledge transfer or training?</strong>",
        "That timeline seems ambitious but achievable. <strong>What are the potential bottlenecks or dependencies that could impact your delivery schedule, and how might we mitigate them?</strong>"
    ];

    return responses[Math.floor(Math.random() * responses.length)];
}

function showTypingIndicator() {
    isTyping = true;
    const indicator = document.getElementById('typing-indicator');
    const sendButton = document.getElementById('send-button');

    indicator.classList.add('active');
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="bi bi-three-dots"></i>';

    scrollChatToBottom();
}

function hideTypingIndicator() {
    isTyping = false;
    const indicator = document.getElementById('typing-indicator');
    const sendButton = document.getElementById('send-button');

    indicator.classList.remove('active');
    sendButton.disabled = false;
    sendButton.innerHTML = '<i class="bi bi-send"></i>';
}

function updateQuickResponses() {
    // Update quick response suggestions based on conversation context
    const quickResponses = [
        'Can you elaborate on that?',
        'What are the alternatives?',
        'How would this scale?',
        'What about security considerations?',
        'That makes sense, continue.',
        'I need more details on implementation.'
    ];

    const container = document.querySelector('#quick-responses .d-flex');
    container.innerHTML = '';

    // Show 3-4 random suggestions
    const shuffled = quickResponses.sort(() => 0.5 - Math.random()).slice(0, 4);
    shuffled.forEach(response => {
        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-outline-secondary quick-response';
        button.textContent = response;
        button.onclick = () => useQuickResponse(response);
        container.appendChild(button);
    });
}

function useQuickResponse(response) {
    const input = document.getElementById('message-input');
    input.value = response;
    input.focus();
    updateCharCount();
}

function scrollChatToBottom() {
    const chatContainer = document.getElementById('chat-messages');
    setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }, 100);
}

function loadSession(sessionId) {
    // Remove active class from all sessions
    document.querySelectorAll('.session-card').forEach(card => {
        card.classList.remove('active');
    });

    // Add active class to selected session
    event.target.closest('.session-card').classList.add('active');

    currentSessionId = sessionId;

    // Load session data (in real implementation, this would fetch from API)
    console.log(`Loading session: ${sessionId}`);

    // Update session title and info
    // This would be populated with real session data
}

function startNewSession() {
    const modal = new bootstrap.Modal(document.getElementById('newSessionModal'));
    modal.show();
}

// FIND THIS FUNCTION in sessions.html:
function createNewSession() {
    // ... existing code ...

    fetch('{{ url_for("new_session") }}', {
        method: 'POST',
        body: formDataToSend
    })
    .then(response => response.json())  // ← PROBLEM: Expects JSON but gets HTML redirect
    .then(data => {
        // Handle JSON response
    })
    .catch(error => {
        console.error('Session creation error:', error);
        alert('Failed to create session');  // ← This is the message you see!
    });
}

// REPLACE WITH THIS:
function createNewSession() {
    const form = document.getElementById('newSessionForm');
    const formData = new FormData(form);

    const sessionData = {
        name: document.getElementById('session_name').value,
        role: document.getElementById('session_role').value,
        project: document.getElementById('existing_project').value,
        initial_idea: document.getElementById('initial_idea').value
    };

    if (!sessionData.name || !sessionData.role) {
        alert('Please fill in the required fields');
        return;
    }

    // Create proper form data with CSRF token
    const formDataToSend = new FormData();
    formDataToSend.append('session_name', sessionData.name);
    formDataToSend.append('role', sessionData.role);
    formDataToSend.append('existing_project', sessionData.project);
    formDataToSend.append('initial_idea', sessionData.initial_idea);
    formDataToSend.append('csrf_token', '{{ csrf_token() }}');

    fetch('{{ url_for("new_session") }}', {
        method: 'POST',
        body: formDataToSend
    })
    .then(response => {
        // Handle redirect response properly
        if (response.redirected) {
            bootstrap.Modal.getInstance(document.getElementById('newSessionModal')).hide();
            window.location.href = response.url;
        } else if (response.ok) {
            // Handle success case
            bootstrap.Modal.getInstance(document.getElementById('newSessionModal')).hide();
            window.location.reload();
        } else {
            throw new Error('Session creation failed');
        }
    })
    .catch(error => {
        console.error('Session creation error:', error);
        alert('Failed to create session: ' + error.message);
    });
}

function refreshSessions() {
    // Refresh sessions list
    location.reload();
}

function exportSession() {
    // Export current session as PDF or JSON
    alert('Session export feature would generate a downloadable file with conversation history and insights');
}

function generateFromSession() {
    // Generate code from current session insights
    window.location.href = `{{ url_for('code_dashboard') }}?session_id=${currentSessionId}`;
}

function pauseSession() {
    // Pause current session
    alert('Session paused. You can resume anytime.');
}

function endSession() {
    if (confirm('Are you sure you want to end this session? All progress will be saved.')) {
        // End session logic
        alert('Session ended successfully');
    }
}

// Auto-save session state periodically
setInterval(() => {
    if (currentSessionId) {
        // Auto-save logic would go here
        console.log('Auto-saving session state...');
    }
}, 30000); // Every 30 seconds
</script>
{% endblock %}
